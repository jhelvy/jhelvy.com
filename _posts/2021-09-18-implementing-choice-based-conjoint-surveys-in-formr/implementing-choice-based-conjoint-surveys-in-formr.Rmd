---
title: Implementing choice-based conjoint surveys in R
description: |
  A how-to guide for using R to design and implement choice-based conjoint surveys using [formr.org](https://formr.org/)
author: John Paul Helveston
date: '2021-09-18'
preview: "images/example.png"
categories:
  - R
  - tutorials
  - conjoint
draft: true
output:
  distill::distill_article:
    self_contained: false
    toc: true
---

```{r setup, include=FALSE}
library(dplyr)
library(fontawesome)
```

[formr.org](https://formr.org/) is a flexible platform for making surveys using `r fa("r-project")`. In this post, I'm going to show you one approach for using formr to create a choice-based conjoint survey (I'm going to assume that you know what conjoint surveys are, but if you don't take a look at this [quick introduction](https://sawtoothsoftware.com/conjoint-analysis/cbc)).

Throughout this post, I will use a demo survey about people's preferences for apples with three attributes: `type`, `price`, and `freshness`.^[Yes, people have [actually done conjoint surveys on fruit](https://www.emerald.com/insight/content/doi/10.1108/00070709610150879/full/html) before.] 

You can view the live demo survey [here](https://appleconjoint.formr.org/), and all files used to create the survey are on [this GitHub repo](https://github.com/jhelvy/formr4conjoint).

# Overview

Every formr survey is implemented in a spreadsheet. I highly recommend using Google Sheets for this because

1. formr has a button on the admin page to quickly re-load your Google Sheet (otherwise you have to upload a new .xlsx file any time you make changes), and
2. It's easier for collaborating and managing different versions.

Each "survey" (each Google Sheet) must be loaded into a "Run" to make the survey live. Most runs include multiple surveys together to control complex logic, like filtering out a respondent based on their response to a question. 

For this demo, I have designed the run as a combination of three surveys (links below go to each respective Google Sheet):

- [Part 1](https://docs.google.com/spreadsheets/d/1tnt7IBSmOOe0wOZ8F6qN152yHYZMCBCo7_KQ3N1e-t8/edit#gid=1611481919): Intro and target population screen out
- [Part 2](https://docs.google.com/spreadsheets/d/1Ih3Pt6uz-gp5vc0SBxBzl4K0aZoRLwI6dtdtZiXSLz0/edit#gid=1611481919): Conjoint choice questions
- [Part 3](https://docs.google.com/spreadsheets/d/1t6DYMZsf6ZX6r5GVTBemZZhX1RlFTV6weM8w0LzwMK4/edit#gid=1611481919): Demographic and other questions

Don't worry about what's in each sheet just yet - we'll get to that.

# Creating the surveys

I find it much easier to design my surveys using .Rmd files (one .Rmd file per survey). I can knit each .Rmd file to a html page to preview the look and feel how my survey without having to use formr at all. This also provides a way to easily print out the whole survey content as a PDF. 

When I'm happy with how things look, I then carefully copy-paste the content over into separate rows in a Google Sheet. For this demo, I designed the questions in each part using the following three .Rmd files in the "survey" folder of the associated [GitHub repo](https://github.com/jhelvy/formr4conjoint). The links in this table let you compare the .Rmd file and the corresponding Google Sheet:

.Rmd file | Google Sheet
----------|----------------
[p1-intro.Rmd](https://github.com/jhelvy/formr4conjoint/blob/master/survey/p1-intro.Rmd) | [appleConjoint_p1](https://docs.google.com/spreadsheets/d/1tnt7IBSmOOe0wOZ8F6qN152yHYZMCBCo7_KQ3N1e-t8/edit#gid=1611481919)
[p2-choice-questions.Rmd](https://github.com/jhelvy/formr4conjoint/blob/master/survey/p2-choice-questions.Rmd) | [appleConjoint_p2](https://docs.google.com/spreadsheets/d/1Ih3Pt6uz-gp5vc0SBxBzl4K0aZoRLwI6dtdtZiXSLz0/edit#gid=1611481919)
[p3-demos.Rmd](https://github.com/jhelvy/formr4conjoint/blob/master/survey/p3-demos.Rmd) | [appleConjoint_p3](https://docs.google.com/spreadsheets/d/1t6DYMZsf6ZX6r5GVTBemZZhX1RlFTV6weM8w0LzwMK4/edit#gid=1611481919)

# Defining the choice questions

The central component of every conjoint survey is the set of randomized choice questions. To implement these in formr, you first need to define the set of choice questions you want to ask each respondent. I use the [conjointTools](https://jhelvy.github.io/conjointTools/) package (which I wrote `r emo::ji('smile')`) to create these questions. The code to create this specific demo survey is in the [`make_choice_questions.R`](https://github.com/jhelvy/formr4conjoint/blob/master/survey/make_choice_questions.R) file in the repo. 

The data frame of randomized choice questions is saved as the [`choice_questions.csv`](https://raw.githubusercontent.com/jhelvy/formr4conjoint/master/survey/choice_questions.csv) file. Once created, you'll need to host it somewhere on the web so that it can be read in to your Google Sheet. For this demo, the file is hosted on the GitHub repo, but you can also upload your `choice_questions.csv` file inside your Run (see the "Upload Files" button on the left side menu), which will generate a unique url to the file.

# Implementing the choice questions

Implementing the choice questions in the [appleConjoint_p2](https://docs.google.com/spreadsheets/d/1Ih3Pt6uz-gp5vc0SBxBzl4K0aZoRLwI6dtdtZiXSLz0/edit#gid=1611481919) Google Sheet is perhaps the most complex part of the whole survey design. To do so, I made the following calculations in the first few rows of the sheet:

1. Read in the full `choice_questions.csv` file.
2. Randomly generate a `respondentID` by sampling from all possible `respID` values in the choice questions.
3. Create a new data frame (`df` in the sheet) that includes only the rows for the `respondentID`.
4. Create a `df_json` object that converts the `df` data frame to JSON.

That last step is a bit of a hack, but the reason this is necessary is because each new page on formr is essentially a new R session, so every time you start a new page all your previous objects are no longer there and all your libraries need to be re-loaded. The only objects you have access to on separate pages are items that are stored in the resulting survey data, so we have to "serialize" the `df` object as one long JSON object so that we can access it later in other pages.

Once we have everything set up, we can then start defining choice questions. In each choice question row, the first thing I do is define the questions label and then write a code chunk to create multiple data frames to store the values to display for each alternative. For example, on row 10 of the [appleConjoint_p2](https://docs.google.com/spreadsheets/d/1Ih3Pt6uz-gp5vc0SBxBzl4K0aZoRLwI6dtdtZiXSLz0/edit#gid=1611481919) Google Sheet, you can see the following code chunk under the question label:

```{r, eval=FALSE}
library(dplyr)
alts <- jsonlite::fromJSON(df_json) %>% filter(qID == 1)
alt1 <- alts %>% filter(altID == 1)
alt2 <- alts %>% filter(altID == 2)
alt3 <- alts %>% filter(altID == 3)
```

In this chunk, the `alts` data frame is created by converting the `df_json` object into a data frame and filtering for all alternatives for the first question. Then the `alts` data frame is broken into three more data frames (`alt1`, `alt2`, and `alt3`) which contain the information about each alternative. These data frames are then used to display information about each alternative. For example, the first alternative is defined using this code:

```{r, eval=FALSE}
**Option 1**

![](`r alt1$image`){width=100}

**Type**: `r alt1$type`
**Price**: $ `r alt1$price` / lb
**Freshness**: `r alt1$freshness`
```

When rendered in formr, the three options looks like this:

<center>
<img src="images/example.png" width=500>
</center>

And that's it! The nice thing about this approach is that the only thing I need to modify in these code chunks for the remaining choice questions is the question number used to define the `alts` data frame. Other than that, the code for the question label and the alternatives can be reused on the rest of the choice questions.

# Implementing the surveys in formr

You'll need to upload each Google Sheet survey into formr to convert them into surveys. Go to your admin page, click on "Create Survey", then import one of the Google Sheets. This creates one survey. On the left panel you can click "Test Survey" to preview it.

Once you have all three surveys loaded into formr, you can then assemble them into a "Run" by clicking on "Runs -> Create New Run". Give the run a name, then add your survey to the run by clicking on the `r fa("pen-square")` icon. You'll want to add all three surveys, and then at the end add a stopping point by clicking the `r fa("stop")` icon. You can use other logic to control how the user navigates through the survey, such as a "Skip Forward" (`r fa("forward")` icon) to screen respondents out before letting them get to a later part of the survey. 

The specific logic used in this demo is as follows:

```
Start (part 1)
  |
  V
Check screen out question --> Screen out non-target respondents
  |
  V
Choice questions (part 2)
  |
  V
Check choice responses --> Screen out respondents that chose 
  |                        all same responses
  V
Final demographic and other questions (part 3)
  |
  V
Finish
```

Notice that there are two points where respondents can be screened out of the survey:

1. At the end of part 1, I ask a question to identify if the respondent is part of the target population I am interested in. This allows me to screen people out of the survey eary on before they get too far in if they're not who I'm looking for. In this demo, I ask if they prefer the color Red or Blue and screen out people who chose Blue.
2. At the end of part 2, I compute whether or not the respondent chose the same response for every choice question or not, which is a good indicator that they were probably just clicking through the survey. I don't want these respondents in my sample, so I screen them out here.

Here is a screenshot of the specific run settings:

```{r, layout="l-body-outset"}
knitr::include_graphics("images/run.png")
```

# Preview and check

The link to the survey will be `https://your_run_name.formr.org`. You can control whether your survey is "live" or not by modifying the "volume" icons. For collecting data, I recommend setting it to the `r fa("volume-down")` icon, which means people who have the link can access the survey.

But before you go live, it's a good idea to do some quick testing. You can test each survey separately from their respective survey admin pages, and you can also test the entire run from the run admin page (check the left side menu). When testing, you will likely run into pages that look like this


